<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>프레임별 PNG 캡처 & GIF 변환</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
    <style>
      #capture-area {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 1px solid #ccc;
        margin-bottom: 16px;
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
      }
      .download-link {
        display: inline-block;
        margin: 4px;
      }
      .options {
        margin: 12px 0;
      }
      label {
        display: block;
        margin: 8px 0 4px;
      }
    </style>
  </head>
  <body>
    <h3>한 글자씩 PNG 캡처 & GIF 생성기</h3>
    <p>텍스트를 입력하고 옵션을 조정한 뒤 버튼을 클릭하세요.</p>

    <div class="options">
      <label for="textInput">텍스트 입력:</label>
      <input id="textInput" value="📦안녕😀" />

      <label for="bgColor">배경 색상:</label>
      <input type="color" id="bgColor" value="#ffffff" />

      <label for="textColor">글자 색상:</label>
      <input type="color" id="textColor" value="#000000" />

      <label for="fontSize">글자 크기: <span id="fontSizeValue">48</span>px</label>
      <input type="range" id="fontSize" min="24" max="120" value="48" />

      <label for="speed">프레임 간 속도 (ms): <span id="speedValue">200</span>ms</label>
      <input type="range" id="speed" min="50" max="1000" step="50" value="200" />

      <label for="width">GIF 가로 크기(px): <span id="widthValue">100</span></label>
      <input type="range" id="width" min="50" max="400" value="100" />

      <label for="height">GIF 세로 크기(px): <span id="heightValue">100</span></label>
      <input type="range" id="height" min="50" max="400" value="100" />

      <label for="scale">해상도 배율 (1x~3x):</label>
      <select id="scale">
        <option value="1">1x</option>
        <option value="2">2x</option>
        <option value="3">3x</option>
      </select>
    </div>

    <button onclick="captureFrames()">캡처 및 GIF 생성</button>
    <br /><br />
    <div id="capture-area"></div>
    <div id="download-container"></div>

    <script>
      const updateLabel = (id, value) => (document.getElementById(id).innerText = value);
      ["fontSize", "speed", "width", "height"].forEach((id) =>
        document.getElementById(id).addEventListener("input", (e) => updateLabel(id + "Value", e.target.value))
      );

      async function captureFrames() {
        const text = document.getElementById("textInput").value.trim();
        const bgColor = document.getElementById("bgColor").value;
        const textColor = document.getElementById("textColor").value;
        const fontSize = parseInt(document.getElementById("fontSize").value, 10);
        const frameDelay = parseInt(document.getElementById("speed").value, 10);
        const scale = parseInt(document.getElementById("scale").value, 10);
        const gifWidth = parseInt(document.getElementById("width").value, 10) * scale;
        const gifHeight = parseInt(document.getElementById("height").value, 10) * scale;

        const captureArea = document.getElementById("capture-area");
        const container = document.getElementById("download-container");
        const frameImages = [];

        captureArea.style.width = gifWidth  + "px";
        captureArea.style.height = gifHeight  + "px";
        captureArea.style.fontSize = fontSize * scale + "px";
        captureArea.style.backgroundColor = bgColor;
        captureArea.style.color = textColor;

        container.innerHTML = "";

        const chars = Array.from(text);
        for (let i = 0; i < chars.length; i++) {
          captureArea.innerText = chars[i];

          await new Promise((resolve) => setTimeout(resolve, 100));
          const canvas = await html2canvas(captureArea, {
            scale: 1, // 실제 캡처는 우리가 사이즈 조절해서 이미 확대됨
          });
          const dataURL = canvas.toDataURL("image/png");
          frameImages.push(dataURL);
        }

        function makeGifFromPngArray(imageArray) {
          gifshot.createGIF(
            {
              images: imageArray,
              interval: frameDelay / 1000,
              gifWidth: gifWidth,
              gifHeight: gifHeight,
              numFrames: imageArray.length,
              frameDuration: 1,
              sampleInterval: 10,
            },
            function (obj) {
              if (!obj.error) {
                const image = obj.image;
                const preview = document.createElement("img");
                preview.src = image;
                document.body.appendChild(preview);

                const downloadLink = document.createElement("a");
                downloadLink.href = image;
                downloadLink.download = "output.gif";
                downloadLink.textContent = "GIF 다운로드";
                document.body.appendChild(downloadLink);
              } else {
                console.error("GIF 생성 실패:", obj.errorMsg);
              }
            }
          );
        }

        makeGifFromPngArray(frameImages);
      }
    </script>
  </body>
</html>
